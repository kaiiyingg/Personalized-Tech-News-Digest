{% extends 'base.html' %}
{% block title %}My Digest - Learning Stream{% endblock %}
{% block content %}
<div class="dashboard-wrapper">
    <aside class="sidebar">
        <div class="sidebar-section">
            <h2>Menu</h2>
            <ul>
                <li><a href="{{ url_for('index') }}">Discover</a></li>
            </ul>
        </div>
        <div class="sidebar-section user-summary">
            <h3>User</h3>
            <span>Welcome, {{ username }}!</span><br>
            <span>Sources: {{ sources_count }}</span><br>
            <span>Liked Articles: {{ liked_count }}</span>
        </div>
    </aside>
    <main class="main-content">
        <div class="dashboard-header">
            <form class="search-form" method="GET" action="{{ url_for('index') }}">
                <input type="text" name="q" placeholder="Search articles..." value="{{ request.args.get('q', '') }}">
                <button type="submit">Search</button>
            </form>
        </div>
        <div class="digest-stream">
            <h2>Latest Tech Articles</h2>
            {# Show the instruction if present in the first article #}
            {% if articles and articles[0].instruction %}
                {{ articles[0].instruction | safe }}
            {% endif %}
            {% if articles %}
                <div class="articles-list">
                    {% for article in articles %}
                        {% if not article.instruction %}
                        <div class="article-card">
                            <h3><a href="{{ article.article_url }}" target="_blank">{{ article.title }}</a></h3>
                            <div class="article-meta">
                                <span class="source">Source: {{ article.source_name }}</span>
                                <span class="date">Published: {{ article.published_at or 'No date' }}</span>
                                <span class="ingested">Ingested: {{ article.ingested_at }}</span>
                                <span class="updated">Updated: {{ article.updated_at or 'N/A' }}</span>
                            </div>
                            <p>{{ article.summary }}</p>
                            <div class="article-actions">
                                <form method="POST" action="{{ url_for('mark_read', article_id=article.id) }}" style="display:inline;">
                                    <button type="submit" class="btn-read">{% if article.is_read %}Mark Unread{% else %}Mark Read{% endif %}</button>
                                </form>
                                {% if article.is_liked %}
                                    <form method="POST" action="{{ url_for('unlike_article', article_id=article.id) }}" style="display:inline;">
                                        <button type="submit" class="btn-like liked">&#9733; Liked</button>
                                    </form>
                                {% else %}
                                    <form method="POST" action="{{ url_for('like_article', article_id=article.id) }}" style="display:inline;">
                                        <button type="submit" class="btn-like">&#9734; Like</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        <div class="article-card">
                            <h3><a href="{{ article.article_url }}" target="_blank">{{ article.title }}</a></h3>
                            <div class="article-meta">
                                <span class="source">Source: {{ article.source_name }}</span>
                                <span class="date">Published: {{ article.published_at or 'No date' }}</span>
                                <span class="ingested">Ingested: {{ article.ingested_at }}</span>
                                <span class="updated">Updated: {{ article.updated_at or 'N/A' }}</span>
                            </div>
                            <p>{{ article.summary }}</p>
                            <div class="article-actions">
                                <form method="POST" action="{{ url_for('mark_read', article_id=article.id) }}" style="display:inline;">
                                    <button type="submit" class="btn-read">{% if article.is_read %}Mark Unread{% else %}Mark Read{% endif %}</button>
                                </form>
                                {% if article.is_liked %}
                                    <form method="POST" action="{{ url_for('unlike_article', article_id=article.id) }}" style="display:inline;">
                                        <button type="submit" class="btn-like liked">&#9733; Liked</button>
                                    </form>
                                {% else %}
                                    <form method="POST" action="{{ url_for('like_article', article_id=article.id) }}" style="display:inline;">
                                        <button type="submit" class="btn-like">&#9734; Like</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>No articles found. Add sources to get started!</p>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}